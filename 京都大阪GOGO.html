<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 京阪GOGO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 全局變數與美學設定 (保持不變) --- */
        :root {
            --location-bg: #334155; /* Slate-700 */
            --location-text: #f1f5f9;
            --transit-bg: #f8fafc;
            --transit-border: #3b82f6;
            --wait-bg: #fef3c7; /* Amber-100 */
            --wait-text: #78350f; /* Amber-900 */
            --wait-border: #f59e0b; /* Amber-500 */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #8ca6db 100%);
            background-attachment: fixed;
            color: #1e293b;
            overflow-x: hidden;
        }

        .font-mono-num { 
            font-family: 'Roboto Mono', monospace;
        } 

        /* --- V11 排版修正：強制文字靠左 --- */
        .timeline-spine {
            position: absolute;
            left: 88px;
            top: 0;
            bottom: 0;
            width: 4px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 0;
            border-radius: 2px;
        }
        
        .time-col {
            width: 80px;
            flex-shrink: 0;
            padding-top: 16px;
            padding-right: 10px;
            text-align: right;
        }

        .card-wrapper {
            flex-grow: 1;
            margin-left: 20px;
        }
        
        .timeline-item .timeline-dot {
            position: absolute;
            left: 81px;
            top: 16px; 
            width: 18px;
            height: 18px; 
            border-radius: 50%;
            border: 4px solid #1e293b;
            z-index: 20;
        }
        .type-location .timeline-dot { background-color: #fff; border-color: var(--location-bg); }
        .type-transit .timeline-dot { background-color: #3b82f6; border-color: var(--transit-bg); }
        /* V20: 等待活動專屬點 */
        .type-wait .timeline-dot { background-color: var(--wait-border); border-color: var(--wait-bg); }


        /* --- 卡片通用樣式 --- */
        .timeline-card {
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            margin-bottom: 1.5rem;
            cursor: pointer; /* 新增：讓滑鼠變成手指形狀，提示可點擊 */
        }
        .timeline-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        /* 新增：卡片點擊時的微小反饋 */
        .timeline-card:active {
            transform: scale(0.98);
        }

        /* --- 類型 1: 地點卡片 (景點、住宿、餐廳、逛街) --- */
        .type-location {
            background-color: var(--location-bg);
            color: var(--location-text);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .type-location .tag-bg { background-color: rgba(255,255,255,0.15); color: #e2e8f0; border: 1px solid rgba(255,255,255,0.2); }
        
        .detail-text {
            text-align: left !important;
            word-break: break-word; 
            overflow-wrap: break-word;
            font-size: 1rem; 
            line-height: 1.75rem; 
        }
        .type-location .detail-text { 
            color: #e2e8f0;
        }

        /* --- 類型 2: 交通卡片 --- */
        .type-transit {
            background-color: var(--transit-bg);
            color: #1e293b;
            border-left: 6px solid var(--transit-border);
            border-right: 1px solid #e2e8f0;
            border-top: 1px dashed #cbd5e1;
            border-bottom: 1px dashed #cbd5e1;
        }
        .type-transit .tag-bg { background-color: #3b82f6; color: white; }
        .type-transit .detail-box { background-color: #ffffff; color: #334155; border: 1px solid #e2e8f0; }
        
        /* --- 類型 3: 等待/緩衝卡片 (V20 新增) --- */
        .type-wait {
            background-color: var(--wait-bg);
            color: var(--wait-text);
            border-left: 6px solid var(--wait-border);
            border-right: 1px solid #e2e8f0;
            border-top: 1px dashed #fcd34d;
            border-bottom: 1px dashed #fcd34d;
        }
        .type-wait .tag-bg { background-color: var(--wait-border); color: white; }
        .type-wait .time-col div:first-child { color: var(--wait-border); }

        /* 雪花動畫 */
        @keyframes fall {
            0% { transform: translateY(-10vh); opacity: 0; }
            10% { opacity: 0.8; }
            100% { transform: translateY(100vh); opacity: 0.5; }
        }
        .snowflake {
            position: fixed;
            color: #fff;
            z-index: 50;
            animation: fall linear infinite;
            pointer-events: none;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.5);
        }

        /* --- 新增：記帳 Modal 樣式 --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            width: 90%;
            max-width: 400px;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: translateY(20px);
            transition: transform 0.3s ease;
            position: relative;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .cat-btn {
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 8px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #64748b;
            background: white;
            transition: all 0.2s;
        }
        .cat-btn:hover { background: #f1f5f9; }
        .cat-btn.selected {
            border-color: #3b82f6;
            background: #eff6ff;
            color: #3b82f6;
        }
        
        /* 記帳徽章樣式 */
        .expense-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444; /* Red-500 */
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            z-index: 5;
            font-family: 'Roboto Mono', monospace;
        }
        .type-transit .expense-badge { background: #10b981; /* Green-500 */ }
    </style>

    <script>
        // --- 1. 資料定義 (V25: 修正 Day4 金閣寺時間) ---
        window.getRefinedItineraryData = () => {
            return {
                "Day1": [
                    { id: 'd1_1', time: '02:20', activity: '統聯客運（往桃園機場）', details: '02:01從台中站發車\n(預估抵達)朝馬站02:20 桃園機場04:20', transport: '客運', duration: '2hr ', type: '交通', dep_time: '02:20', arr_time: '04:20', dep_loc: '朝馬站', arr_loc: '桃園機場', note: '02:01從台中站發車' },
                    { id: 'd1_2', time: '04:20', activity: '桃園國際機場T2 報到', details: '中華航空C10156\n桃園8:05關西11:35', transport: '停留', duration: '3hr 45min', type: '彈性', dep_time: '04:20', arr_time: '08:05', dep_loc: '桃園機場', arr_loc: '登機口', note: '國際航班請預留充足時間報到/安檢' },
                    { id: 'd1_3', time: '08:05', activity: '中華航空CI0156 (飛往關西)', details: '桃園8:05關西11:35', transport: '飛機', duration: '3hr 30min', type: '交通', dep_time: '08:05', arr_time: '11:35', dep_loc: '桃園機場', arr_loc: '關西機場', note: '' },
                    { id: 'd1_4', time: '11:35', activity: '關西國際機場T1 出關', details: '約停留2hr出關\n(取行李時劃位0.5hr後的JR HARUKA)', transport: '停留', duration: '2hr 39min', type: '彈性', dep_time: '11:35', arr_time: '14:14', dep_loc: '機場', arr_loc: 'JR劃位', note: '記得劃位JR HARUKA' },
                    { id: 'd1_5', time: '14:14', activity: 'JR HARUKA (往京都)', details: '關西機場14:14 京都15:34', transport: 'JR', duration: '1hr 20min', type: '交通', dep_time: '14:14', arr_time: '15:34', dep_loc: '關西機場', arr_loc: '京都', note: '' },
                    { id: 'd1_6', time: '15:34', activity: '步行 (往地鐵烏丸線)', details: '步行5min到地鐵烏丸線', transport: '步行', duration: '5min', type: '交通', dep_time: '15:34', arr_time: '15:39', dep_loc: '京都車站', arr_loc: '地鐵入口', note: '' },
                    { id: 'd1_6_wait', time: '15:39', activity: '步行後等候 地鐵烏丸線', details: '等候緩衝時間 (預留 3 分鐘)', transport: '等待', duration: '3min', type: '彈性', dep_time: '15:39', arr_time: '15:42', dep_loc: '地鐵入口', arr_loc: '地鐵入口', note: '步行後的等車緩衝' },
                    { id: 'd1_7', time: '15:42', activity: '地鐵烏丸線 (往國際會館)', details: '京都15:42烏丸御池15:47', transport: '地鐵', duration: '5min', type: '交通', dep_time: '15:42', arr_time: '15:47', dep_loc: '京都', arr_loc: '烏丸御池', note: '' },
                    { id: 'd1_8', time: '15:47', activity: '步行 (往酒店)', details: '步行8min到京都御池insomnia酒店', transport: '步行', duration: '8min', type: '交通', dep_time: '15:47', arr_time: '15:55', dep_loc: '烏丸御池', arr_loc: '酒店', note: '' },
                    { id: 'd1_9', time: '15:55', activity: '京都御池insomnia酒店', details: 'Check-in辦理入住手續並稍作休息 30min', transport: '住宿', duration: '41min', type: '住宿', dep_time: '15:55', arr_time: '16:25', dep_loc: '酒店', arr_loc: '出發', note: 'Check-in後休息' },
                    { id: 'd1_9_walk', time: '16:25', activity: '步行 (往地鐵烏丸線)', details: '步行5min到地鐵烏丸線', transport: '步行', duration: '5min', type: '交通', dep_time: '16:25', arr_time: '16:30', dep_loc: '酒店', arr_loc: '烏丸御池站', note: '' },                    
                    { id: 'd1_10_wait', time: '16:30', activity: '步行後等候 地鐵烏丸線', details: '等候緩衝時間 (預留 6 分鐘)', transport: '等待', duration: '6min', type: '彈性', dep_time: '16:30', arr_time: '16:36', dep_loc: '烏丸御池', arr_loc: '烏丸御池', note: '等待 16:36 班次' },
                    { id: 'd1_10', time: '16:36', activity: '地鐵烏丸線 (往新田邊)', details: '烏丸御池16:36 五條16:40', transport: '地鐵', duration: '4min', type: '交通', dep_time: '16:36', arr_time: '16:40', dep_loc: '烏丸御池', arr_loc: '五條', note: '' },
                    { id: 'd1_11', time: '16:40', activity: '步行 (往五條天神宮)', details: '步行13min到五條天神宮', transport: '步行', duration: '15min', type: '交通', dep_time: '16:40', arr_time: '16:55', dep_loc: '五條', arr_loc: '天神宮', note: '' },
                    { id: 'd1_12', time: '16:55', activity: '五條天神宮', details: '參觀40min', transport: '停留', duration: '40min', type: '景點', dep_time: '16:55', arr_time: '17:35', dep_loc: '天神宮', arr_loc: '天神宮', note: '祈求平安 / 小巧精緻的神社' },
                    { id: 'd1_13', time: '17:35', activity: '步行 (往GU)', details: '步行20min到GU', transport: '步行', duration: '20min', type: '交通', dep_time: '17:35', arr_time: '17:55', dep_loc: '天神宮', arr_loc: 'GU', note: '' },
                    { id: 'd1_14', time: '17:55', activity: 'GU Kyōto-Yodobashi', details: '採購2hr ', transport: '停留', duration: '2hr ', type: '逛街', dep_time: '17:55', arr_time: '19:55', dep_loc: 'GU', arr_loc: 'GU', note: '採購服飾清單' },
                    { id: 'd1_15_walk', time: '19:55', activity: '步行 (往京都塔)', details: '步行5min到京都塔', transport: '步行', duration: '5min', type: '交通', dep_time: '19:55', arr_time: '20:00', dep_loc: 'GU', arr_loc: '京都塔', note: '' },
                    { id: 'd1_15', time: '20:00', activity: '京都塔', details: '拍照10min', transport: '停留', duration: '10min', type: '景點', dep_time: '20:00', arr_time: '20:10', dep_loc: '京都塔', arr_loc: '京都塔', note: '欣賞夜景' },
                    { id: 'd1_16_walk', time: '20:10', activity: '步行 (往炸牛排 京都勝牛)', details: '步行5min到京都勝牛', transport: '步行', duration: '5min', type: '交通', dep_time: '20:10', arr_time: '20:15', dep_loc: '京都塔', arr_loc: '京都勝牛', note: '' },
                    { id: 'd1_16', time: '20:15', activity: '炸牛排 京都勝牛', details: '晚餐1hr ', transport: '停留', duration: '1hr ', type: '吃飯', dep_time: '20:15', arr_time: '21:15', dep_loc: '京都勝牛', arr_loc: '京都勝牛', note: '人氣炸牛排 / 預計用餐1hr' },
                    { id: 'd1_17_walk', time: '21:15', activity: '步行 (往地鐵烏丸線)', details: '步行5min到地鐵烏丸線', transport: '步行', duration: '5min', type: '交通', dep_time: '21:15', arr_time: '21:20', dep_loc: '京都勝牛', arr_loc: '京都車站', note: '' },
                    { id: 'd1_17_wait', time: '21:20', activity: '步行後等候 地鐵烏丸線', details: '等候緩衝時間 (預留 6分鐘)', transport: '等待', duration: '4min', type: '彈性', dep_time: '21:20', arr_time: '21:26', dep_loc: '京都車站', arr_loc: '京都車站', note: '步行後的等車緩衝' },
                    { id: 'd1_17', time: '21:26', activity: '地鐵烏丸線 (往國際會館)', details: '京都21:26 烏丸御池21:31', transport: '地鐵', duration: '5min', type: '交通', dep_time: '21:26', arr_time: '21:31', dep_loc: '京都', arr_loc: '烏丸御池', note: '' },
                    { id: 'd1_18', time: '21:31', activity: '步行 (回酒店)', details: '步行8min到京都御池insomnia酒店', transport: '步行', duration: '8min', type: '交通', dep_time: '21:31', arr_time: '21:39', dep_loc: '烏丸御池', arr_loc: '酒店', note: '' },
                    { id: 'd1_19', time: '21:40', activity: '京都御池insomnia酒店', details: '回到酒店休息/自由活動', transport: '住宿', duration: 'N/A', type: '住宿', dep_time: '21:40', arr_time: 'N/A', dep_loc: '酒店', arr_loc: 'N/A', note: '結束 Day 1' },
                ],
                "Day2": [
                    { id: 'd2_0', time: '06:00', activity: '京都御池insomnia酒店', details: '早上從酒店出發', transport: '住宿', duration: '0min', type: '住宿', dep_time: '06:00', arr_time: '06:00', dep_loc: '酒店', arr_loc: '酒店', note: '開始 Day 2' },
                    { id: 'd2_0_walk', time: '06:00', activity: '步行 (往地鐵東西線)', details: '步行5min到地鐵東西線', transport: '步行', duration: '5min', type: '交通', dep_time: '06:00', arr_time: '06:05', dep_loc: '酒店', arr_loc: '地鐵站', note: '' },
                    { id: 'd2_0_wait', time: '06:05', activity: '步行後等候 地鐵東西線', details: '等候緩衝時間 (預留 6 分鐘)', transport: '等待', duration: '6min', type: '彈性', dep_time: '06:05', arr_time: '06:11', dep_loc: '地鐵站', arr_loc: '地鐵站', note: '步行後的等車緩衝' },
                    { id: 'd2_1', time: '06:11', activity: '地鐵東西線 (往太秦天神川)', details: '烏丸御池06:11 二條06:15', transport: '地鐵', duration: '4min', type: '交通', dep_time: '06:11', arr_time: '06:15', dep_loc: '烏丸御池', arr_loc: '二條', note: '早起前往嵐山避人潮' },
                    { id: 'd2_1_wait', time: '06:15', activity: '轉乘及等候 JR 嵯峨野線', details: '地鐵抵達二條站，等候 06:30 的 JR 嵯峨野線', transport: '等待', duration: '15min', type: '彈性', dep_time: '06:15', arr_time: '06:30', dep_loc: '二條', arr_loc: '二條', note: '轉乘緩衝時間' },
                    { id: 'd2_2', time: '06:30', activity: 'JR嵯峨野線 (往龜岡)', details: '二條06:30 嵯峨嵐山06:39', transport: 'JR', duration: '9min', type: '交通', dep_time: '06:30', arr_time: '06:39', dep_loc: '二條', arr_loc: '嵯峨嵐山', note: '' },
                    { id: 'd2_3_walk', time: '06:39', activity: '步行 (往竹林小徑)', details: '步行15min到嵐山竹林', transport: '步行', duration: '16min', type: '交通', dep_time: '06:39', arr_time: '06:55', dep_loc: '嵯峨嵐山', arr_loc: '竹林小徑', note: '' },
                    { id: 'd2_4', time: '06:55', activity: '嵐山竹林小徑', details: '停留1hr ', transport: '停留', duration: '1hr ', type: '景點', dep_time: '06:55', arr_time: '07:55', dep_loc: '竹林小徑', arr_loc: '竹林小徑', note: '享受清晨寧靜 / 避開人群' },
                    { id: 'd2_5_walk', time: '07:55', activity: '步行 (往御髪神社)', details: '從竹林步行至御髪神社 (約5-10min)', transport: '步行', duration: '5min', type: '交通', dep_time: '07:55', arr_time: '08:00', dep_loc: '竹林小徑', arr_loc: '御髪神社', note: '' },
                    { id: 'd2_5', time: '08:00', activity: '御髪神社', details: '參觀20min', transport: '停留', duration: '20min', type: '景點', dep_time: '08:00', arr_time: '08:20', dep_loc: '御髪神社', arr_loc: '御髪神社', note: '日本唯一的頭髮神社' },
                    { id: 'd2_6_walk', time: '08:20', activity: '步行 (往野宮神社)', details: '步行10min到野宮神社', transport: '步行', duration: '10min', type: '交通', dep_time: '08:20', arr_time: '08:30', dep_loc: '御髪神社', arr_loc: '野宮神社', note: '' },
                    { id: 'd2_6', time: '08:30', activity: '野宮神社', details: '參觀30min', transport: '停留', duration: '30min', type: '景點', dep_time: '08:30', arr_time: '09:00', dep_loc: '野宮神社', arr_loc: '野宮神社', note: '祈求良緣' },
                    { id: 'd2_7_walk', time: '09:00', activity: '步行 (往天龍寺)', details: '步行5min到天龍寺', transport: '步行', duration: '5min', type: '交通', dep_time: '09:00', arr_time: '09:05', dep_loc: '野宮神社', arr_loc: '天龍寺', note: '' },
                    { id: 'd2_7', time: '09:05', activity: '天龍寺', details: '參觀1.5hr\n世界遺產曹源池庭園', transport: '停留', duration: '1hr 30min', type: '景點', dep_time: '09:05', arr_time: '10:35', dep_loc: '天龍寺', arr_loc: '天龍寺', note: '世界遺產' },
                    { id: 'd2_8_walk', time: '10:35', activity: '步行 (往渡月橋)', details: '步行10min到渡月橋', transport: '步行', duration: '10min', type: '交通', dep_time: '10:35', arr_time: '10:45', dep_loc: '天龍寺', arr_loc: '渡月橋', note: '' },
                    { id: 'd2_8', time: '10:45', activity: '渡月橋', details: '停留1hr \n拍照打卡熱點', transport: '停留', duration: '1hr ', type: '景點', dep_time: '10:45', arr_time: '11:45', dep_loc: '渡月橋', arr_loc: '渡月橋', note: '嵐山地標' },
                    { id: 'd2_9_walk', time: '11:45', activity: '步行 (往JR 嵯峨野線)', details: '步行15min到JR 嵯峨野線', transport: '步行', duration: '15min', type: '交通', dep_time: '11:45', arr_time: '12:00', dep_loc: '渡月橋', arr_loc: '嵯峨嵐山', note: '' },
                    { id: 'd2_1_wait', time: '12:00', activity: '等候 JR 嵯峨野線', details: '等候12:17的 JR 嵯峨野線', transport: '等待', duration: '17min', type: '彈性', dep_time: '12:00', arr_time: '12:17', dep_loc: '嵯峨嵐山', arr_loc: '嵯峨嵐山', note: '轉乘緩衝時間' },
                    { id: 'd2_9', time: '12:17', activity: 'JR嵯峨野線 (往京都)', details: '嵯峨嵐山12:17 二條12:26', transport: 'JR', duration: '9min', type: '交通', dep_time: '12:17', arr_time: '12:26', dep_loc: '嵯峨嵐山', arr_loc: '二條', note: '' },
                    { id: 'd2_10', time: '12:26', activity: '步行 (往二條城)', details: '步行9min', transport: '步行', duration: '9min', type: '交通', dep_time: '12:26', arr_time: '12:35', dep_loc: '二條站', arr_loc: '二條城', note: '' },
                    { id: 'd2_11', time: '12:35', activity: '二條城', details: '停留1.5hr\n參觀德川幕府大政奉還處', transport: '停留', duration: '1hr 30min', type: '景點', dep_time: '12:35', arr_time: '14:05', dep_loc: '二條城', arr_loc: '二條城', note: '德川幕府歷史遺址' },
                    { id: 'd2_12_walk', time: '14:05', activity: '步行 (往地鐵東西線)', details: '步行8min到地鐵東西線', transport: '步行', duration: '8min', type: '交通', dep_time: '14:05', arr_time: '14:13', dep_loc: '二條城', arr_loc: '二條城前', note: '' },
                    { id: 'd2_12_wait', time: '14:13', activity: '步行後等候 地鐵東西線', details: '等候緩衝時間 (預留 8 分鐘)', transport: '等待', duration: '8min', type: '彈性', dep_time: '14:13', arr_time: '14:21', dep_loc: '二條城前', arr_loc: '二條城前', note: '步行後的等車緩衝' },
                    { id: 'd2_12', time: '14:21', activity: '地鐵東西線 (往六地藏)', details: '二條城前14:21 三條京阪14:26', transport: '地鐵', duration: '5min', type: '交通', dep_time: '14:21', arr_time: '14:26', dep_loc: '二條城前', arr_loc: '三條京阪', note: '' },
                    { id: 'd2_13', time: '14:26', activity: '步行 (往花見小路)', details: '步行9min到花見小路', transport: '步行', duration: '9min', type: '交通', dep_time: '14:26', arr_time: '14:35', dep_loc: '三條京阪', arr_loc: '花見小路', note: '' },
                    { id: 'd2_14', time: '14:35', activity: '花見小路', details: '停留50min\n運氣好可以看到藝伎', transport: '停留', duration: '50min', type: '景點', dep_time: '14:35', arr_time: '15:25', dep_loc: '花見小路', arr_loc: '花見小路', note: '尋找藝伎的蹤影' },
                    { id: 'd2_15_walk', time: '15:25', activity: '步行 (往祇園白川)', details: '步行5min到祇園白川', transport: '步行', duration: '5min', type: '交通', dep_time: '15:25', arr_time: '15:30', dep_loc: '花見小路', arr_loc: '祇園白川', note: '' },
                    { id: 'd2_15', time: '15:30', activity: '祇園白川', details: '停留 50min', transport: '停留', duration: '50min', type: '景點', dep_time: '15:30', arr_time: '16:20', dep_loc: '祇園白川', arr_loc: '祇園白川', note: '京都小橋流水景觀' },
                    { id: 'd2_16_walk', time: '16:20', activity: '步行 (往八坂神社)', details: '步行10min到八坂神社', transport: '步行', duration: '10min', type: '交通', dep_time: '16:20', arr_time: '16:30', dep_loc: '祇園白川', arr_loc: '八坂神社', note: '' },
                    { id: 'd2_16', time: '16:30', activity: '京都八坂神社', details: '參觀1.5hr', transport: '停留', duration: '1hr 30min', type: '景點', dep_time: '16:30', arr_time: '18:00', dep_loc: '八坂神社', arr_loc: '八坂神社', note: '京都三大祭典之一' },
                    { id: 'd2_17_walk', time: '18:00', activity: '步行 (往麵屋 豬一)', details: '步行20min到豬一', transport: '步行', duration: '20min', type: '交通', dep_time: '18:00', arr_time: '18:20', dep_loc: '八坂神社', arr_loc: '麵屋豬一', note: '' },
                    { id: 'd2_17', time: '18:20', activity: '麵屋 豬一', details: '晚餐1hr \n人氣排隊名店', transport: '停留', duration: '1hr ', type: '吃飯', dep_time: '18:20', arr_time: '19:20', dep_loc: '麵屋 豬一', arr_loc: '麵屋 豬一', note: '人氣拉麵 / 提前排隊' },
                    { id: 'd2_18_walk', time: '19:20', activity: '步行 (回酒店)', details: '步行28min到京都御池insomnia酒店', transport: '步行', duration: '28min', type: '交通', dep_time: '19:20', arr_time: '19:48', dep_loc: '麵屋豬一', arr_loc: '酒店', note: '' },
                    { id: 'd2_18', time: '19:50', activity: '京都御池insomnia酒店', details: '回到酒店休息/自由活動', transport: '住宿', duration: 'N/A', type: '住宿', dep_time: '19:50', arr_time: 'N/A', dep_loc: '酒店', arr_loc: 'N/A', note: '結束 Day 2' },
                ],
                "Day3": [
                    { id: 'd3_0_start', time: '05:00', activity: '京都御池insomnia酒店', details: '早上從酒店出發', transport: '住宿', duration: '0min', type: '住宿', dep_time: '05:00', arr_time: '05:00', dep_loc: '酒店', arr_loc: '酒店', note: '開始 Day 3' },
                    { id: 'd3_0_taxi', time: '05:00', activity: '計程車 (往二寧坂)', details: '計程車 10min到二年坂', transport: '計程車', duration: '10min', type: '交通', dep_time: '05:00', arr_time: '05:10', dep_loc: '酒店', arr_loc: '二年坂', note: '建議搭乘計程車' },
                    { id: 'd3_1', time: '05:10', activity: '二寧坂(二年坂)', details: '停留20min', transport: '停留', duration: '20min', type: '景點', dep_time: '05:10', arr_time: '05:30', dep_loc: '二年坂', arr_loc: '二年坂', note: '清晨限定 / 避開人潮' },
                    { id: 'd3_2_walk', time: '05:30', activity: '步行 (往三年坂)', details: '步行5min三年坂', transport: '步行', duration: '5min', type: '交通', dep_time: '05:30', arr_time: '05:35', dep_loc: '二年坂', arr_loc: '三年坂', note: '' },
                    { id: 'd3_2', time: '05:35', activity: '產寧坂(三年坂)', details: '停留20min', transport: '停留', duration: '20min', type: '景點', dep_time: '05:35', arr_time: '05:55', dep_loc: '三年坂', arr_loc: '三年坂', note: '摔倒有三年內厄運的傳說' },
                    { id: 'd3_3_walk', time: '05:55', activity: '步行 (往清水寺)', details: '步行10min到清水寺', transport: '步行', duration: '10min', type: '交通', dep_time: '05:55', arr_time: '06:05', dep_loc: '三年坂', arr_loc: '清水寺', note: '' },
                    { id: 'd3_3', time: '06:05', activity: '清水寺', details: '參觀2hr', transport: '停留', duration: '2hr', type: '景點', dep_time: '06:05', arr_time: '08:05', dep_loc: '清水寺', arr_loc: '清水寺', note: '早上較少人 / 國寶清水舞台' },
                    { id: 'd3_4_walk', time: '08:05', activity: '步行 (往京阪本線)', details: '步行20min到京阪本線', transport: '步行', duration: '20min', type: '交通', dep_time: '08:05', arr_time: '08:25', dep_loc: '清水寺', arr_loc: '清水五條', note: '' },
                    { id: 'd3_4_wait', time: '08:25', activity: '步行後等候 京阪本線', details: '等候緩衝時間 (預留 12 分鐘)', transport: '等待', duration: '12min', type: '彈性', dep_time: '08:25', arr_time: '08:37', dep_loc: '清水五條', arr_loc: '清水五條', note: '步行後的等車緩衝' },
                    { id: 'd3_4', time: '08:37', activity: '京阪本線 準急行 (往淀屋橋)', details: '清水五條08:37 伏見稻荷08:44', transport: '電車', duration: '7min', type: '交通', dep_time: '08:37', arr_time: '08:44', dep_loc: '清水五條', arr_loc: '伏見稻荷', note: '搭乘京阪本線' },
                    { id: 'd3_5', time: '08:44', activity: '步行 (往伏見稻荷大社)', details: '步行6min到伏見稻荷大社', transport: '步行', duration: '6min', type: '交通', dep_time: '08:44', arr_time: '08:50', dep_loc: '伏見稻荷', arr_loc: '大社', note: '' },
                    { id: 'd3_6', time: '08:50', activity: '伏見稻荷大社', details: '參觀1.5hr', transport: '停留', duration: '1hr 30min', type: '景點', dep_time: '08:50', arr_time: '10:20', dep_loc: '伏見稻荷大社', arr_loc: '伏見稻荷大社', note: '必拍千本鳥居' },
                    { id: 'd3_7_walk', time: '10:20', activity: '步行 (往JR奈良線)', details: '步行5min到JR奈良線', transport: '步行', duration: '5min', type: '交通', dep_time: '10:20', arr_time: '10:25', dep_loc: '伏見稻荷大社', arr_loc: '稻荷', note: '' },
                    { id: 'd3_7_wait', time: '10:25', activity: '步行後等候 JR奈良線', details: '等候緩衝時間 (預留 10 分鐘)', transport: '等待', duration: '10min', type: '彈性', dep_time: '10:25', arr_time: '10:35', dep_loc: '稻荷', arr_loc: '稻荷', note: '步行後的等車緩衝' },
                    { id: 'd3_7', time: '10:35', activity: 'JR奈良線 (往奈良)', details: '稻荷10:35宇治10:52', transport: 'JR', duration: '17min', type: '交通', dep_time: '10:35', arr_time: '10:52', dep_loc: '稻荷', arr_loc: '宇治', note: '' },
                    { id: 'd3_8', time: '10:52', activity: '步行 (往中村藤吉)', details: '步行8min到中村藤吉本店', transport: '步行', duration: '8min', type: '交通', dep_time: '10:52', arr_time: '11:00', dep_loc: '宇治站', arr_loc: '中村藤吉', note: '' },
                    { id: 'd3_9', time: '11:00', activity: '中村藤吉本店 宇治店', details: '午餐1hr (必吃抹茶)', transport: '停留', duration: '1hr', type: '吃飯', dep_time: '11:00', arr_time: '12:00', dep_loc: '中村藤吉', arr_loc: '中村藤吉', note: '必吃抹茶甜點' },
                    { id: 'd3_10_walk', time: '12:00', activity: '步行 (往平等院鳳凰堂)', details: '步行10min到鳳凰堂', transport: '步行', duration: '10min', type: '交通', dep_time: '12:00', arr_time: '12:10', dep_loc: '中村藤吉', arr_loc: '鳳凰堂', note: '' },
                    { id: 'd3_10', time: '12:10', activity: '平等院鳳凰堂', details: '參觀1.5hr', transport: '停留', duration: '1hr 30min', type: '景點', dep_time: '12:10', arr_time: '13:40', dep_loc: '鳳凰堂', arr_loc: '鳳凰堂', note: '十元硬幣上的圖案' },
                    { id: 'd3_11_walk', time: '13:40', activity: '步行 (往宇治神社)', details: '步行10min到宇治神社', transport: '步行', duration: '10min', type: '交通', dep_time: '13:40', arr_time: '13:50', dep_loc: '鳳凰堂', arr_loc: '宇治神社', note: '' },
                    { id: 'd3_11', time: '13:50', activity: '宇治神社(兔子神社)', details: '參觀40min', transport: '停留', duration: '40min', type: '景點', dep_time: '13:50', arr_time: '14:30', dep_loc: '宇治神社', arr_loc: '宇治神社', note: '充滿兔子元素的可愛神社' },
                    { id: 'd3_12_walk', time: '14:30', activity: '步行 (往宇治上神社)', details: '步行5min到宇治上神社', transport: '步行', duration: '5min', type: '交通', dep_time: '14:30', arr_time: '14:35', dep_loc: '宇治神社', arr_loc: '宇治上神社', note: '' },
                    { id: 'd3_12', time: '14:35', activity: '宇治上神社', details: '參觀40min\n世界遺產 / 日本現存最古老的神社建築', transport: '停留', duration: '40min', type: '景點', dep_time: '14:35', arr_time: '15:15', dep_loc: '宇治上神社', arr_loc: '宇治上神社', note: '世界遺產' },
                    { id: 'd3_13_walk', time: '15:15', activity: '步行 (往京阪宇治線)', details: '步行10min到京阪宇治線', transport: '步行', duration: '10min', type: '交通', dep_time: '15:15', arr_time: '15:25', dep_loc: '宇治上神社', arr_loc: '宇治站', note: '' },
                    { id: 'd3_13_wait_2', time: '15:25', activity: '步行後等候 京阪宇治線', details: '等候緩衝時間 (預留 5 分鐘)', transport: '等待', duration: '5min', type: '彈性', dep_time: '15:25', arr_time: '15:30', dep_loc: '宇治站', arr_loc: '宇治站', note: '步行後的等車緩衝' },
                    { id: 'd3_13', time: '15:30', activity: '京阪宇治線 (往中書島)', details: '宇治15:30 中書島15:56', transport: '電車', duration: '26min', type: '交通', dep_time: '15:30', arr_time: '15:56', dep_loc: '宇治', arr_loc: '中書島', note: '' },
                    // V20 新增：等待京阪本線 (6min)
                    { id: 'd3_13_wait', time: '15:56', activity: '轉乘及等候 京阪本線', details: '抵達中書島，等候 16:02 的特急列車', transport: '等待', duration: '6min', type: '彈性', dep_time: '16:56', arr_time: '16:02', dep_loc: '中書島', arr_loc: '中書島', note: '轉乘緩衝時間' },
                    { id: 'd3_14', time: '16:02', activity: '京阪本線 特急 (往出町柳)', details: '中書島16:02 祇園四條16:13', transport: '電車', duration: '11min', type: '交通', dep_time: '16:02', arr_time: '16:13', dep_loc: '中書島', arr_loc: '祇園四條', note: '一般特急不需要額外費用' },
                    { id: 'd3_15', time: '16:13', activity: '步行 (往錦市場)', details: '步行12min到錦市場', transport: '步行', duration: '12min', type: '交通', dep_time: '16:13', arr_time: '16:25', dep_loc: '祇園四條', arr_loc: '錦市場', note: '' },
                    { id: 'd3_16', time: '16:25', activity: '錦市場', details: '逛街+晚餐2hr \n京都的廚房', transport: '停留', duration: '2hr ', type: '逛街', dep_time: '16:25', arr_time: '18:25', dep_loc: '錦市場', arr_loc: '錦市場', note: '邊走邊吃 / 京都的廚房' },
                    { id: 'd3_17_walk', time: '18:25', activity: '步行 (往弁慶石)', details: '步行10min到弁慶石', transport: '步行', duration: '10min', type: '交通', dep_time: '18:25', arr_time: '18:35', dep_loc: '錦市場', arr_loc: '弁慶石', note: '' },
                    { id: 'd3_17', time: '18:35', activity: '弁慶石', details: '拍照10min', transport: '停留', duration: '15min', type: '景點', dep_time: '18:35', arr_time: '18:45', dep_loc: '弁慶石', arr_loc: '弁慶石', note: '歷史地標 / 義經公與弁慶的傳說' },
                    { id: 'd3_18_walk', time: '18:45', activity: '步行 (回酒店)', details: '步行15min到京都御池insomnia酒店', transport: '步行', duration: '15min', type: '交通', dep_time: '18:45', arr_time: '19:00', dep_loc: '弁慶石', arr_loc: '酒店', note: '' },
                    { id: 'd3_18', time: '19:00', activity: '京都御池insomnia酒店', details: '回到酒店休息/自由活動', transport: '住宿', duration: 'N/A', type: '住宿', dep_time: '19:00', arr_time: 'N/A', dep_loc: '酒店', arr_loc: 'N/A', note: '結束 Day 3' },
                ],
                "Day4": [
                    // --- 早晨出發 (08:00 - 08:43) ---
                    { id: 'd4_0', time: '08:00', activity: '京都御池insomnia酒店', details: '辦理退房手續並寄放行李，準備出發', transport: '住宿', duration: '0min', type: '住宿', dep_time: '08:00', arr_time: '08:00', dep_loc: '酒店', arr_loc: '酒店', note: '開始 Day 4 / 寄放行李' },
                    
                    { id: 'd4_0_walk', time: '08:00', activity: '步行 (往地鐵烏丸線)', details: '步行5min到地鐵烏丸線', transport: '步行', duration: '5min', type: '交通', dep_time: '08:00', arr_time: '08:05', dep_loc: '酒店', arr_loc: '烏丸御池站', note: '' },
                    
                    { id: 'd4_0_wait', time: '08:05', activity: '步行後等候 地鐵烏丸線', details: '等候緩衝時間 (預留 8 分鐘)', transport: '等待', duration: '8min', type: '彈性', dep_time: '08:05', arr_time: '08:13', dep_loc: '烏丸御池', arr_loc: '烏丸御池', note: '等待 08:13 班次' },

                    { id: 'd4_1', time: '08:13', activity: '地鐵烏丸線 (往國際會館)', details: '烏丸御池08:13 北大路08:19', transport: '地鐵', duration: '6min', type: '交通', dep_time: '08:13', arr_time: '08:19', dep_loc: '烏丸御池', arr_loc: '北大路', note: '' },

                    { id: 'd4_2_walk', time: '08:19', activity: '步行轉乘 (往巴士總站)', details: '步行2min到北大路巴士總站', transport: '步行', duration: '2min', type: '交通', dep_time: '08:19', arr_time: '08:21', dep_loc: '北大路站', arr_loc: '巴士總站', note: '' },

                    { id: 'd4_2_wait', time: '08:21', activity: '等候 205/204 City Bus', details: '等候 08:28 班次', transport: '等待', duration: '7min', type: '彈性', dep_time: '08:21', arr_time: '08:28', dep_loc: '巴士總站', arr_loc: '巴士總站', note: 'E搭乘處(205) / G搭乘處(204)' },

                    { id: 'd4_2', time: '08:28', activity: '205 City Bus (往西大路七條、京都站)', details: '北大路巴士總站08:28 金閣寺道08:39', transport: '公車', duration: '11min', type: '交通', dep_time: '08:28', arr_time: '08:39', dep_loc: '北大路', arr_loc: '金閣寺道', note: 'OR 204 City Bus (往北大路通、金閣寺、西之京圓町）<br> E搭乘處(205) OR G搭乘處(204)' },

                    { id: 'd4_3_walk', time: '08:39', activity: '步行 (往金閣寺)', details: '步行4min到金閣寺', transport: '步行', duration: '4min', type: '交通', dep_time: '08:39', arr_time: '08:43', dep_loc: '金閣寺道', arr_loc: '金閣寺', note: '' },

                    // --- 金閣寺區域 (修正處) ---
                    { 
                        id: 'd4_3', 
                        time: '09:00', 
                        activity: '金閣寺', 
                        details: '抵達時間08:43，營業時間09:00\n參觀2hr ', 
                        transport: '停留', 
                        duration: '2hr ', // 09:00 到 11:00
                        type: '景點', 
                        dep_time: '09:00', 
                        arr_time: '11:00', 
                        dep_loc: '金閣寺', 
                        arr_loc: '金閣寺', 
                        note: '正式開放時間是09:00' 
                    },

                    { 
                        id: 'd4_4_walk', 
                        time: '11:00', 
                        activity: '步行 (往公車站)', 
                        details: '步行4min到公車站', 
                        transport: '步行', 
                        duration: '4min', 
                        type: '交通', 
                        dep_time: '11:00', 
                        arr_time: '11:04', 
                        dep_loc: '金閣寺', 
                        arr_loc: '金閣寺道', 
                        note: '' 
                    },
                    
                    { 
                        id: 'd4_4_wait', 
                        time: '11:04', 
                        activity: '步行後等候 205 City Bus', 
                        details: '等候緩衝時間 (預留 4 分鐘)', 
                        transport: '等待', 
                        duration: '4min', 
                        type: '彈性', 
                        dep_time: '11:04', 
                        arr_time: '11:08', 
                        dep_loc: '金閣寺道', 
                        arr_loc: '金閣寺道', 
                        note: '等待 11:08 班次' 
                    },

                    { 
                        id: 'd4_4', 
                        time: '11:08', 
                        activity: '205 City Bus (往洛北高校、京都站)', 
                        details: '金閣寺道11:08 下鴨神社前11:28', 
                        transport: '公車', 
                        duration: '20min', 
                        type: '交通', 
                        dep_time: '11:08', 
                        arr_time: '11:28', 
                        dep_loc: '金閣寺道', 
                        arr_loc: '下鴨神社前', 
                        note: 'C乘車處' 
                    },

                    // --- 下鴨神社區域 (後續行程時間未變，只需接續) ---
                    { id: 'd4_5', time: '11:30', activity: '賀茂御祖神社 (下鴨神社)', details: '參觀1hr', transport: '停留', duration: '1hr', type: '景點', dep_time: '11:30', arr_time: '12:30', dep_loc: '下鴨神社', arr_loc: '下鴨神社', note: '世界遺產<br>相生社可購買戒指御守<br>除了主殿商店外 周邊的兩三間商店可以買到其他季節御守（雜太社旁商店）' },

                    { id: 'd4_6_walk', time: '12:30', activity: '步行 (往河合神社)', details: '步行5min到河合神社', transport: '步行', duration: '5min', type: '交通', dep_time: '12:30', arr_time: '12:35', dep_loc: '下鴨神社', arr_loc: '河合神社', note: '' },

                    { id: 'd4_6', time: '12:35', activity: '河合神社', details: '參觀15min', transport: '停留', duration: '15min', type: '景點', dep_time: '12:35', arr_time: '12:50', dep_loc: '河合神社', arr_loc: '河合神社', note: '機動行程看時間刪減 / 祈求美麗的神社' },

                    { id: 'd4_7_walk', time: '12:50', activity: '步行 (往鴨川三角洲)', details: '步行8min到鴨川三角洲', transport: '步行', duration: '8min', type: '交通', dep_time: '12:50', arr_time: '12:58', dep_loc: '河合神社', arr_loc: '鴨川三角洲', note: '' },

                    { id: 'd4_7', time: '13:00', activity: '鴨川三角洲', details: '散步30min', transport: '停留', duration: '30min', type: '景點', dep_time: '13:00', arr_time: '13:30', dep_loc: '鴨川三角洲', arr_loc: '鴨川三角洲', note: '跳烏龜石 / 適合放鬆' },

                    // --- 移動回酒店取行李 ---
                    { id: 'd4_8_walk', time: '13:30', activity: '步行 (往京阪本線)', details: '步行6min到京阪本線', transport: '步行', duration: '6min', type: '交通', dep_time: '13:30', arr_time: '13:36', dep_loc: '鴨川三角洲', arr_loc: '出柳町', note: '' },
                    
                    { id: 'd4_8_wait', time: '13:36', activity: '步行後等候 京阪本線', details: '等候緩衝時間 (預留 3 分鐘)', transport: '等待', duration: '3min', type: '彈性', dep_time: '13:36', arr_time: '13:39', dep_loc: '出柳町', arr_loc: '出柳町', note: '等待 13:39 班次' },

                    { id: 'd4_8', time: '13:39', activity: '京阪本線 準急行 (往淀屋橋)', details: '出柳町13:39 三條13:43', transport: '電車', duration: '4min', type: '交通', dep_time: '13:39', arr_time: '13:43', dep_loc: '出柳町', arr_loc: '三條', note: '' },

                    { id: 'd4_9_walk', time: '13:43', activity: '步行轉乘 (往地鐵東西線)', details: '步行6min轉乘', transport: '步行', duration: '6min', type: '交通', dep_time: '13:43', arr_time: '13:49', dep_loc: '三條', arr_loc: '三條京阪', note: '' },
                    
                    { id: 'd4_9_wait', time: '13:49', activity: '步行後等候 地鐵東西線', details: '等候緩衝時間 (預留 10 分鐘)', transport: '等待', duration: '10min', type: '彈性', dep_time: '13:49', arr_time: '13:59', dep_loc: '三條京阪', arr_loc: '三條京阪', note: '等待 13:59 班次' },

                    { id: 'd4_10', time: '13:59', activity: '地鐵東西線 (往太秦天神川)', details: '三條京阪13:59 烏丸御池14:02', transport: '地鐵', duration: '3min', type: '交通', dep_time: '13:59', arr_time: '14:02', dep_loc: '三條京阪', arr_loc: '烏丸御池', note: '' },

                    { id: 'd4_11', time: '14:02', activity: '步行 (往酒店拿行李)', details: '步行5min到京都御池insomnia酒店', transport: '步行', duration: '8min', type: '交通', dep_time: '14:02', arr_time: '14:10', dep_loc: '烏丸御池', arr_loc: '酒店', note: '' },

                    { id: 'd4_12', time: '14:10', activity: '京都御池insomnia酒店', details: '領取寄放的行李並準備前往大阪', transport: '住宿', duration: '10min', type: '住宿', dep_time: '14:10', arr_time: '14:20', dep_loc: '酒店', arr_loc: '酒店', note: '準備移動到大阪' },

                    // --- 移動到大阪 ---
                    { id: 'd4_13_walk', time: '14:20', activity: '步行 (往地鐵烏丸線)', details: '步行10min到地鐵烏丸線', transport: '步行', duration: '10min', type: '交通', dep_time: '14:20', arr_time: '14:30', dep_loc: '酒店', arr_loc: '烏丸御池', note: '' },
                    
                    { id: 'd4_13_wait', time: '14:30', activity: '步行後等候 地鐵烏丸線', details: '等候緩衝時間 (預留 6 分鐘)', transport: '等待', duration: '6min', type: '彈性', dep_time: '14:30', arr_time: '14:36', dep_loc: '烏丸御池', arr_loc: '烏丸御池', note: '等待 14:36 班次' },

                    { id: 'd4_13', time: '14:36', activity: '地鐵烏丸線 (往竹田)', details: '烏丸御池14:36 京都14:41', transport: '地鐵', duration: '5min', type: '交通', dep_time: '14:36', arr_time: '14:41', dep_loc: '烏丸御池', arr_loc: '京都', note: '' },

                    { id: 'd4_14_wait', time: '14:41', activity: '轉乘及等候 JR京都線', details: '抵達京都站，等候 15:00 新快速列車', transport: '等待', duration: '19min', type: '彈性', dep_time: '14:41', arr_time: '15:00', dep_loc: '京都', arr_loc: '京都', note: '轉乘緩衝' },

                    { id: 'd4_14', time: '15:00', activity: 'JR京都線 新快速 (往姬路經湖西線)', details: '京都15:00 大阪15:28\n(往姬路經湖西線)', transport: 'JR', duration: '28min', type: '交通', dep_time: '15:00', arr_time: '15:28', dep_loc: '京都', arr_loc: '大阪', note: '新快速' },

                    { id: 'd4_15_walk', time: '15:28', activity: '步行轉乘 (往地鐵御堂筋線)', details: '步行10min到地鐵御堂筋線\n(人多則搭計程車)', transport: '步行', duration: '10min', type: '交通', dep_time: '15:28', arr_time: '15:38', dep_loc: '大阪', arr_loc: '梅田', note: '' },
                    
                    { id: 'd4_15_wait', time: '15:38', activity: '步行後等候 地鐵御堂筋線', details: '等候緩衝時間 (預留 10 分鐘)', transport: '等待', duration: '10min', type: '彈性', dep_time: '15:38', arr_time: '15:48', dep_loc: '梅田', arr_loc: '梅田', note: '等待 15:48 班次<br>人多則搭計程車' },

                    { id: 'd4_16', time: '15:48', activity: '地鐵御堂筋線 (往中百舌鳥)', details: '梅田15:48 本町15:53', transport: '地鐵', duration: '5min', type: '交通', dep_time: '15:48', arr_time: '15:53', dep_loc: '梅田', arr_loc: '本町', note: '' },

                    { id: 'd4_17_wait', time: '15:53', activity: '轉乘及等候 地鐵中央線', details: '本町站轉乘 (OR 步行15min)', transport: '等待', duration: '8min', type: '彈性', dep_time: '15:53', arr_time: '16:01', dep_loc: '本町', arr_loc: '本町', note: '轉乘緩衝<br>OR步行15min' },

                    { id: 'd4_18', time: '16:01', activity: '地鐵中央線 (往學研奈良登美丘)', details: '本町16:01 堺筋本町16:02', transport: '地鐵', duration: '1min', type: '交通', dep_time: '16:01', arr_time: '16:02', dep_loc: '本町', arr_loc: '堺筋本町', note: '' },

                    { id: 'd4_19', time: '16:02', activity: '步行 (往酒店)', details: '步行5min到大阪本町都城市酒店', transport: '步行', duration: '8min', type: '交通', dep_time: '16:02', arr_time: '16:10', dep_loc: '堺筋本町', arr_loc: '酒店', note: '' },

                    // --- 大阪酒店與晚餐 ---
                    { id: 'd4_20', time: '16:10', activity: '大阪本町都城市酒店', details: 'Check-in 休息\n(預計 17:40 出發前往晚餐)', transport: '住宿', duration: '1hr 30min', type: '住宿', dep_time: '16:10', arr_time: '17:40', dep_loc: '酒店', arr_loc: '出發', note: '休息片刻' },

                    { id: 'd4_21_walk', time: '17:40', activity: '步行 (往敘敘苑)', details: '步行20min到敘敘苑', transport: '步行', duration: '20min', type: '交通', dep_time: '17:40', arr_time: '18:00', dep_loc: '酒店', arr_loc: '敘敘苑', note: '' },

                    { id: 'd4_21', time: '18:00', activity: '敘敘苑 大丸心齋橋店', details: '晚餐2hr', transport: '停留', duration: '2hr', type: '吃飯', dep_time: '18:00', arr_time: '20:00', dep_loc: '敘敘苑', arr_loc: '敘敘苑', note: '訂位18:00' },

                    { id: 'd4_22_walk', time: '20:00', activity: '步行 (回酒店)', details: '步行20min到大阪本町都城市酒店', transport: '步行', duration: '20min', type: '交通', dep_time: '20:00', arr_time: '20:20', dep_loc: '敘敘苑', arr_loc: '酒店', note: '' },

                    { id: 'd4_22', time: '20:20', activity: '大阪本町都城市酒店', details: '回到酒店休息/自由活動', transport: '住宿', duration: 'N/A', type: '住宿', dep_time: '20:20', arr_time: 'N/A', dep_loc: '酒店', arr_loc: 'N/A', note: '結束 Day 4' },
                ],
                "Day5": [
                    { id: 'd5_0', time: '07:30', activity: '大阪本町都城市酒店', details: '早上從酒店出發', transport: '住宿', duration: '0min', type: '住宿', dep_time: '07:30', arr_time: '07:30', dep_loc: '酒店', arr_loc: '酒店', note: '開始 Day 5' },
                    // V22 修正：步行 15min 到地鐵站 (07:30 -> 07:45)
                    { id: 'd5_0_walk', time: '07:30', activity: '步行 (往地鐵御堂筋線)', details: '步行15min到地鐵御堂筋線', transport: '步行', duration: '15min', type: '交通', dep_time: '07:30', arr_time: '07:45', dep_loc: '酒店', arr_loc: '地鐵站', note: '' },
                    // V22 修正：等待緩衝 4min (07:45 -> 07:49)
                    { id: 'd5_0_wait', time: '07:45', activity: '步行後等候 地鐵御堂筋線', details: '等候緩衝時間 (預留 4 分鐘)', transport: '等待', duration: '4min', type: '彈性', dep_time: '07:45', arr_time: '07:49', dep_loc: '地鐵站', arr_loc: '地鐵站', note: '步行後的等車緩衝' },
                    { id: 'd5_1', time: '07:49', activity: '地鐵御堂筋線/北大阪急行線 (往箕面萱野)', details: '本町07:49 江坂箕面萱野08:20', transport: '地鐵', duration: '31min', type: '交通', dep_time: '07:49', arr_time: '08:20', dep_loc: '本町', arr_loc: '箕面萱野', note: '搭乘御堂筋線至江坂接續北大阪急行線' },
                    // V21 修正：將步行與等待時間分離
                    { id: 'd5_2_walk', time: '08:20', activity: '步行 (轉乘公車)', details: '步行10min到公車站', transport: '步行', duration: '10min', type: '交通', dep_time: '08:20', arr_time: '08:30', dep_loc: '箕面萱野', arr_loc: '公車站', note: '' },
                    { id: 'd5_2_wait', time: '08:30', activity: '步行後等候 30 Bus (往勝尾寺)', details: '等候緩衝時間 (等候 09:00 班次)', transport: '等待', duration: '30min', type: '彈性', dep_time: '08:30', arr_time: '09:00', dep_loc: '公車站', arr_loc: '公車站', note: '8號乘車處等待09:00班次' },
                    { id: 'd5_2', time: '09:00', activity: '30 Bus (往勝尾寺)', details: '箕面萱野09:00 勝尾寺09:22', transport: '公車', duration: '22min', type: '交通', dep_time: '09:00', arr_time: '09:22', dep_loc: '箕面萱野', arr_loc: '勝尾寺', note: '8號乘車處' },
                    { id: 'd5_3', time: '09:25', activity: '勝尾寺', details: '參觀 2hr \n30 bus (往箕面萱野站)', transport: '停留', duration: '2hr ', type: '景點', dep_time: '09:25', arr_time: '11:25', dep_loc: '勝尾寺', arr_loc: '勝尾寺', note: '達摩寺 / 滿滿的勝利達摩' },
                    { id: 'd5_2_wait', time: '11:25', activity: '步行後等候 30 Bus (往箕面萱野站)', details: '等候緩衝時間 (等候 11:50 班次)', transport: '等待', duration: '25min', type: '彈性', dep_time: '11:25', arr_time: '11:50', dep_loc: '公車站', arr_loc: '公車站', note: '步行後的等車緩衝' },
                    { id: 'd5_4', time: '11:50', activity: '30 Bus (往箕面萱野)', details: '勝尾寺11:50 箕面萱野12:11', transport: '公車', duration: '21min', type: '交通', dep_time: '11:50', arr_time: '12:11', dep_loc: '勝尾寺', arr_loc: '箕面萱野', note: '' },
                    // V21 修正：將步行與等待時間分離
                    { id: 'd5_5_walk', time: '12:11', activity: '步行 (轉乘地鐵)', details: '步行10min到地鐵北大阪急行線', transport: '步行', duration: '10min', type: '交通', dep_time: '12:11', arr_time: '12:21', dep_loc: '箕面萱野', arr_loc: '箕面萱野站', note: '' },
                    { id: 'd5_5_walk_wait', time: '12:21', activity: '步行後等候 地鐵北大阪急行線', details: '等候緩衝時間 (預留 6 分鐘)', transport: '等待', duration: '6min', type: '彈性', dep_time: '12:21', arr_time: '12:27', dep_loc: '箕面萱野站', arr_loc: '箕面萱野站', note: '步行後的等車緩衝' },
                    { id: 'd5_5', time: '12:27', activity: '地鐵北大阪急行線/御堂筋線 (往中百舌鳥)', details: '箕面萱野12:27 江坂 本町12:57', transport: '地鐵', duration: '30min', type: '交通', dep_time: '12:27', arr_time: '12:57', dep_loc: '箕面萱野', arr_loc: '本町', note: '搭乘北大阪急行線至江坂接續御堂筋線' },
                    // V20 新增：等待地鐵中央線 (4min)
                    { id: 'd5_5_wait', time: '12:57', activity: '轉乘及等候 地鐵中央線', details: '抵達本町，等候 13:01 的地鐵中央線', transport: '等待', duration: '4min', type: '彈性', dep_time: '12:57', arr_time: '13:01', dep_loc: '本町', arr_loc: '本町', note: '轉乘緩衝時間' },
                    { id: 'd5_6', time: '13:01', activity: '地鐵中央線 (往生駒)', details: '本町13:01 谷町四丁目13:04', transport: '地鐵', duration: '3min', type: '交通', dep_time: '13:01', arr_time: '13:04', dep_loc: '本町', arr_loc: '谷町四丁目', note: '' },
                    { id: 'd5_6_walk', time: '13:04', activity: '步行 (往咖喱店)', details: '步行6min到咖喱店', transport: '步行', duration: '6min', type: '交通', dep_time: '13:04', arr_time: '13:10', dep_loc: '谷町四丁目', arr_loc: '咖喱店', note: '' },
                    { id: 'd5_7', time: '13:10', activity: '呑めるカレーハウス インディー内本町店', details: '午餐1hr ', transport: '停留', duration: '1hr ', type: '吃飯', dep_time: '13:10', arr_time: '14:10', dep_loc: '咖喱店', arr_loc: '咖喱店', note: '日式咖哩' },
                    { id: 'd5_8_walk', time: '14:10', activity: '步行 (往大阪城)', details: '步行20min到大阪城', transport: '步行', duration: '20min', type: '交通', dep_time: '14:10', arr_time: '14:30', dep_loc: '咖喱店', arr_loc: '大阪城', note: '' },
                    { id: 'd5_8', time: '14:30', activity: '大阪城', details: '參觀2hr ', transport: '停留', duration: '2hr ', type: '景點', dep_time: '14:30', arr_time: '16:30', dep_loc: '大阪城', arr_loc: '大阪城', note: '豐臣秀吉的城堡' },
                    { id: 'd5_9_walk', time: '16:30', activity: '步行 (往地鐵谷町線)', details: '步行20min到地鐵谷町線', transport: '步行', duration: '20min', type: '交通', dep_time: '16:30', arr_time: '16:50', dep_loc: '大阪城', arr_loc: '谷町四丁目', note: '' },
                    { id: 'd5_9_wait', time: '16:50', activity: '步行後等候 地鐵谷町線', details: '等候緩衝時間 (預留 10 分鐘)', transport: '等待', duration: '10min', type: '彈性', dep_time: '16:50', arr_time: '17:00', dep_loc: '谷町四丁目', arr_loc: '谷町四丁目', note: '步行後的等車緩衝' },
                    { id: 'd5_9', time: '17:00', activity: '地鐵谷町線 (往喜連瓜破)', details: '谷町四丁目17:00 天王寺17:07', transport: '地鐵', duration: '7min', type: '交通', dep_time: '17:00', arr_time: '17:07', dep_loc: '谷町四丁目', arr_loc: '天王寺', note: '' },
                    { id: 'd5_10_walk', time: '17:07', activity: '步行 (往阿倍野HARUKAS)', details: '步行3min到阿倍野HARUKAS', transport: '步行', duration: '3min', type: '交通', dep_time: '17:07', arr_time: '17:10', dep_loc: '天王寺', arr_loc: '阿倍野HARUKAS', note: '' },
                    { id: 'd5_10', time: '17:10', activity: '阿倍野HARUKAS', details: '看夜景1.5hr', transport: '停留', duration: '1hr 30min', type: '景點', dep_time: '17:10', arr_time: '18:40', dep_loc: '阿倍野HARUKAS', arr_loc: '阿倍野HARUKAS', note: '大阪最高的摩天大樓' },
                    { id: 'd5_11_walk', time: '18:40', activity: '步行 (往地鐵谷町線)', details: '步行3min到地鐵谷町線', transport: '步行', duration: '3min', type: '交通', dep_time: '18:40', arr_time: '18:43', dep_loc: '阿倍野HARUKAS', arr_loc: '天王寺', note: '' },
                    { id: 'd5_11_wait', time: '18:43', activity: '步行後等候 地鐵谷町線', details: '等候緩衝時間 (預留 1 分鐘)', transport: '等待', duration: '1min', type: '彈性', dep_time: '18:43', arr_time: '18:44', dep_loc: '天王寺', arr_loc: '天王寺', note: '步行後的等車緩衝' },
                    { id: 'd5_11', time: '18:44', activity: '地鐵谷町線 (往都島)', details: '天王寺18:44 谷町九丁目18:48', transport: '地鐵', duration: '4min', type: '交通', dep_time: '18:44', arr_time: '18:48', dep_loc: '天王寺', arr_loc: '谷町九丁目', note: '' },
                    { id: 'd5_12_wait', time: '18:48', activity: '轉乘及等候 地鐵千日前線', details: '等候緩衝時間 (預留 5 分鐘)', transport: '等待', duration: '5min', type: '彈性', dep_time: '18:48', arr_time: '18:53', dep_loc: '地鐵站', arr_loc: '地鐵站', note: '轉乘緩衝時間' },
                    { id: 'd5_12', time: '18:53', activity: '地鐵千日前線 (往野田阪神)', details: '谷町九丁目18:53 日本橋18:54', transport: '地鐵', duration: '1min', type: '交通', dep_time: '18:53', arr_time: '18:54', dep_loc: '谷町九丁目', arr_loc: '日本橋', note: '' },
                    { id: 'd5_13', time: '18:54', activity: '步行 (往牛舌檸檬)', details: '步行6min到牛舌檸檬', transport: '步行', duration: '6min', type: '交通', dep_time: '18:54', arr_time: '19:00', dep_loc: '日本橋', arr_loc: '牛舌檸檬', note: '' },
                    { id: 'd5_14', time: '19:00', activity: '新宿焼肉 牛たんの檸檬大阪本店', details: '晚餐1hr', transport: '停留', duration: '1hr ', type: '吃飯', dep_time: '19:00', arr_time: '20:00', dep_loc: '牛舌檸檬', arr_loc: '牛舌檸檬', note: '預計用餐1小時' },
                    { id: 'd5_15_walk', time: '20:00', activity: '步行 (往地鐵堺筋線)', details: '步行5min到地鐵堺筋線', transport: '步行', duration: '5min', type: '交通', dep_time: '20:00', arr_time: '20:05', dep_loc: '牛舌檸檬', arr_loc: '日本橋', note: '' },
                    { id: 'd5_15_wait', time: '20:05', activity: '步行後等候 地鐵堺筋線', details: '等候緩衝時間 (預留 6 分鐘)', transport: '等待', duration: '6min', type: '彈性', dep_time: '20:05', arr_time: '20:11', dep_loc: '日本橋', arr_loc: '日本橋', note: '步行後的等車緩衝' },
                    { id: 'd5_15', time: '20:11', activity: '地鐵堺筋線 (往北千里)', details: '日本橋20:11 堺筋本町20:14', transport: '地鐵', duration: '3min', type: '交通', dep_time: '20:11', arr_time: '20:14', dep_loc: '日本橋', arr_loc: '堺筋本町', note: '' },
                    { id: 'd5_16', time: '20:14', activity: '步行 (回酒店)', details: '步行6min到大阪本町都城市酒店', transport: '步行', duration: '6min', type: '交通', dep_time: '20:14', arr_time: '20:20', dep_loc: '堺筋本町', arr_loc: '酒店', note: '' },
                    { id: 'd5_17', time: '20:20', activity: '大阪本町都城市酒店', details: '回到酒店休息/自由活動', transport: '住宿', duration: 'N/A', type: '住宿', dep_time: '20:20', arr_time: 'N/A', dep_loc: '酒店', arr_loc: 'N/A', note: '結束 Day 5' },
                ],
                "Day6": [
                    { id: 'd6_0', time: '09:40', activity: '大阪本町都城市酒店', details: '早上從酒店出發', transport: '住宿', duration: '0min', type: '住宿', dep_time: '09:40', arr_time: '09:40', dep_loc: '酒店', arr_loc: '酒店', note: '開始 Day 6' },
                    // V22 修正：步行 20min 到心齋橋商店街 (09:40 -> 10:00)
                    { id: 'd6_1_walk', time: '09:40', activity: '步行 (往心齋橋筋商店街)', details: '步行20min到心齋橋', transport: '步行', duration: '20min', type: '交通', dep_time: '09:40', arr_time: '10:00', dep_loc: '酒店', arr_loc: '心齋橋', note: '' },
                    { id: 'd6_1', time: '10:00', activity: '心齋橋筋商店街 (上午)', details: '營業時間11:00\n閒晃1hr', transport: '停留', duration: '1hr', type: '逛街', dep_time: '10:00', arr_time: '11:00', dep_loc: '心齋橋筋商店街', arr_loc: '心齋橋筋商店街', note: '部分店家 11:00才營業' },
                    { id: 'd6_2', time: '11:00', activity: '味乃家御好燒 (午餐)', details: '午餐1hr', transport: '停留', duration: '1hr', type: '吃飯', dep_time: '11:00', arr_time: '12:00', dep_loc: '味乃家御好燒', arr_loc: '味乃家御好燒', note: '必吃大阪燒 (或大阪燒千房)' },
                    { id: 'd6_3', time: '12:00', activity: '心齋橋筋商店街 (下午)', details: '打烊時間20:00\n逛街7hr', transport: '停留', duration: '7hr', type: '逛街', dep_time: '12:00', arr_time: '19:00', dep_loc: '心齋橋筋商店街', arr_loc: '心齋橋筋商店街', note: '瘋狂購物時間' },
                    { id: 'd6_4', time: '19:00', activity: '晚餐 (道頓崛美食)', details: '晚餐1hr\n路邊攤隨便吃', transport: '停留', duration: '1hr', type: '吃飯', dep_time: '19:00', arr_time: '20:00', dep_loc: '道頓崛', arr_loc: '道頓崛', note: '嘗試道頓堀周邊美食' },
                    { id: 'd6_5', time: '20:00', activity: '步行 (回酒店)', details: '步行20min回大阪本町都城市酒店', transport: '步行', duration: '20min', type: '交通', dep_time: '20:00', arr_time: '20:20', dep_loc: '心齋橋', arr_loc: '酒店', note: '' },
                    { id: 'd6_6', time: '20:20', activity: '大阪本町都城市酒店', details: '回到酒店休息/自由活動', transport: '住宿', duration: 'N/A', type: '住宿', dep_time: '20:20', arr_time: 'N/A', dep_loc: '酒店', arr_loc: 'N/A', note: '結束 Day 6' },
                ],
                "Day7": [
                    // V23 修正：Check-out 結束時間調整為 07:50
                    { id: 'd7_0', time: '07:50', activity: '大阪本町都城市酒店', details: 'Check-out辦理退房手續並準備前往機場', transport: '住宿', duration: '0min', type: '住宿', dep_time: '07:50', arr_time: '07:50', dep_loc: '酒店', arr_loc: '酒店', note: '開始 Day 7 ' },
                    // V23 修正：步行時間改為 07:50 -> 07:55
                    { id: 'd7_1_walk', time: '07:50', activity: '步行 (往地鐵中央線)', details: '步行5min到地鐵中央線', transport: '步行', duration: '5min', type: '交通', dep_time: '07:50', arr_time: '07:55', dep_loc: '酒店', arr_loc: '堺筋本町', note: '' },
                    // V23 修正：等待緩衝時間改為 07:55 -> 08:13 (18min)
                    { id: 'd7_1_wait', time: '07:55', activity: '步行後等候 地鐵中央線 ', details: '等候緩衝時間 (預留 18 分鐘)', transport: '等待', duration: '18min', type: '彈性', dep_time: '07:55', arr_time: '08:13', dep_loc: '堺筋本町', arr_loc: '堺筋本町', note: '步行後的等車緩衝<br> OR搭乘計程車前往南海難波' },
                    { id: 'd7_1', time: '08:13', activity: '地鐵中央線 (往夢洲)', details: '堺筋本町08:13 本町08:14', transport: '地鐵', duration: '1min', type: '交通', dep_time: '08:13', arr_time: '08:14', dep_loc: '堺筋本町', arr_loc: '本町', note: '' },
                    { id: 'd7_2_wait', time: '08:14', activity: '轉乘及等候 地鐵御堂筋線', details: '抵達本町，等候 08:14 的地鐵御堂筋線', transport: '等待', duration: '5min', type: '彈性', dep_time: '08:14', arr_time: '08:19', dep_loc: '本町', arr_loc: '本町', note: '轉乘緩衝時間' },
                    { id: 'd7_2', time: '08:19', activity: '地鐵御堂筋線 (往中百舌鳥)', details: '本町08:19 難波08:22', transport: '地鐵', duration: '3min', type: '交通', dep_time: '08:19', arr_time: '08:22', dep_loc: '本町', arr_loc: '難波', note: '' },
                    // V21 修正：將步行與等候時間分離
                    { id: 'd7_3_walk', time: '08:22', activity: '步行轉乘 (往南海難波)', details: '步行10min到南海難波站', transport: '步行', duration: '10min', type: '交通', dep_time: '08:22', arr_time: '08:32', dep_loc: '難波地鐵站', arr_loc: '南海難波', note: '' },
                    { id: 'd7_3_wait', time: '08:32', activity: '轉乘及等候 南海電鐵', details: '抵達南海難波，等候 09:00 班次', transport: '等待', duration: '28min', type: '彈性', dep_time: '08:32', arr_time: '09:00', dep_loc: '南海難波', arr_loc: '南海難波', note: '搭乘 09:00 班次 （搭乘計程車提早到 則搭乘08:30班次）' },
                    { id: 'd7_4', time: '09:00', activity: '南海特急 (往關西機場)', details: '南海難波09:00 關西機場09:38', transport: '電車', duration: '38min', type: '交通', dep_time: '09:00', arr_time: '09:38', dep_loc: '南海難波', arr_loc: '關西機場', note: 'KLOOK購買南海電鐵特急車票 線上劃位' },
                    { id: 'd7_5', time: '09:40', activity: '關西國際機場T1 報到', details: '中華航空CI0153\n預計 14:30 關西起飛，需提前報到', transport: '停留', duration: '4hr 50min', type: '彈性', dep_time: '09:40', arr_time: '14:30', dep_loc: '機場T1', arr_loc: '登機口', note: '國際航班請預留充足時間報到/安檢' },
                    { id: 'd7_6', time: '14:30', activity: '中華航空CI0153 (飛往桃園)', details: '關西14:30 桃園16:45', transport: '飛機', duration: '2hr 15min', type: '交通', dep_time: '14:30', arr_time: '16:45', dep_loc: '關西', arr_loc: '桃園T2', note: '回程班機' },
                    { id: 'd7_7', time: '16:45', activity: '桃園國際機場T2 入境', details: '約停留2hr出關', transport: '停留', duration: '15min', type: '彈性', dep_time: '16:45', arr_time: '18:45', dep_loc: '桃園T2', arr_loc: '機捷', note: '' },
                    { id: 'd7_8', time: '18:45', activity: '機捷 (往高鐵桃園)', details: '機場第二航廈N/A ➡ A18高鐵桃園N/A', transport: '機捷', duration: '21min', type: '交通', dep_time: 'N/A', arr_time: 'N/A', dep_loc: '機場T2', arr_loc: 'A18高鐵桃園', note: '' },
                    { id: 'd7_9', time: 'N/A', activity: '台灣高鐵 (往台中)', details: '高鐵 桃園➡ 台中', transport: '高鐵', duration: '40min', type: '交通', dep_time: 'N/A', arr_time: 'N/A', dep_loc: '高鐵桃園站', arr_loc: '高鐵台中站', note: '高鐵票需另行購買' },
                    { id: 'd7_10', time: 'N/A', activity: '溫暖的家 / End', details: '旅程結束', transport: '停留', duration: 'N/A', type: '彈性', dep_time: 'N/A', arr_time: 'N/A', dep_loc: '高鐵台中站', arr_loc: '家', note: '結束旅程' },
                ],
            };
        };

        const DATE_MAP = {
            'Day1': '01/11(日)', 'Day2': '01/12(一)', 'Day3': '01/13(二)', 'Day4': '01/14(三)',
            'Day5': '01/15(四)', 'Day6': '01/16(五)', 'Day7': '01/17(六)'
        };
        const DAYS = ['Day1', 'Day2', 'Day3', 'Day4', 'Day5', 'Day6', 'Day7'];
        // --- 地圖導航功能 (已保留) ---
        function getMapLink(activity, day) {
            let query = activity;
            // 嘗試根據日期加入城市名稱以提高準確度
            if (day === 'Day1' || day === 'Day2' || day === 'Day3' || day === 'Day4') {
                query += ' 京都';
            } else if (day === 'Day5' || day === 'Day6' || day === 'Day7') {
                query += ' 大阪';
            }
            const encodedQuery = encodeURIComponent(query);
            return `https://www.google.com/maps/search/?api=1&query=${encodedQuery}`;
        }

        // --- V19/V20 新增：精確活動標籤生成邏輯 ---
        function getDisplayTag(item) {
            if (item.type === '吃飯') return '餐廳';
            if (item.type === '住宿') return '酒店';
            // V21 修正：將純步行和轉乘/交通的標籤分開，讓等待緩衝有自己的標籤
            if (item.transport === '步行') return '純步行';
            if (item.type === '交通') return '轉乘';
            
            if (item.type === '彈性') {
                // 判斷是否為機場相關
                if (item.activity.includes('機場') || item.activity.includes('報到') || item.activity.includes('出關')) return '機場手續';
                // 判斷是否為等待
                if (item.transport === '等待') return '等待緩衝';
                // 判斷是否為行程終點
                if (item.activity.includes('家') || item.activity.includes('End')) return '自由活動';
                return '彈性時段'; // 預設的彈性時段
            }
            
            // 景點, 逛街
            return item.type;
        }

        // --- 視覺分類映射 ---
        function getStyleClass(type, transport) {
            if (transport === '等待') return 'type-wait'; // 優先顯示等待樣式
            if (type === '交通' || transport === '步行') return 'type-transit';
            return 'type-location';
        }
        
        function getActionIcon(type, transport) {
            if (transport === '等待') return '⏱️';
            const icons = {
                '景點': '⛩️', '吃飯': '🍜', '逛街': '🛍️', '住宿': '🛌', '彈性': '⏳'
            };
            return icons[type] || '📌';
        }
        
        // --- 交通圖示映射 ---
        function getTransportIcon(transport) {
            // 飛機
            if (transport.includes('飛機') || transport.includes('華航')) return '🛫';
            // JR / 高鐵
            if (transport.includes('JR') || transport.includes('高鐵')) return '🚄';
            // 地鐵 / 機捷 (捷運)
            if (transport.includes('地鐵') || transport.includes('機捷')) return '🚇';
            // 京阪本線 / 電車 (一般電車) / 南海電鐵
            if (transport.includes('京阪線') || transport.includes('電車') || transport.includes('南海電鐵')) return '🚊';
            // 公車 / 客運 (巴士)
            if (transport.includes('客運') || transport.includes('公車') || transport.includes('Bus')) return '🚌';
            // 計程車
            if (transport.includes('計程車')) return '🚕';
            // 步行
            if (transport.includes('步行')) return '👣';
            // 等待/緩衝 (V20 新增)
            if (transport.includes('等待')) return '⏸️';
            return '🗺️';
        }

        // --- 新增：記帳功能邏輯 ---
        const ExpenseManager = {
            getKey: () => 'itinerary_expenses_v1',
            getExpenses: () => {
                const data = localStorage.getItem(ExpenseManager.getKey());
                return data ? JSON.parse(data) : {};
            },
            saveExpense: (id, amount, category) => {
                const expenses = ExpenseManager.getExpenses();
                if (amount > 0) {
                    expenses[id] = { amount: parseInt(amount), category };
                } else {
                    delete expenses[id];
                }
                localStorage.setItem(ExpenseManager.getKey(), JSON.stringify(expenses));
                window.renderApp(window.itineraryData); // 重新渲染以更新顯示
            },
            getExpense: (id) => {
                const expenses = ExpenseManager.getExpenses();
                return expenses[id] || null;
            },
            getTotal: () => {
                const expenses = ExpenseManager.getExpenses();
                return Object.values(expenses).reduce((sum, item) => sum + item.amount, 0);
            },
            getSummary: () => {
                const expenses = ExpenseManager.getExpenses();
                const summary = { '交通': 0, '餐費': 0, '購物': 0, '景點': 0, '其他': 0, 'total': 0 };
                Object.values(expenses).forEach(item => {
                    if (summary[item.category] !== undefined) {
                        summary[item.category] += item.amount;
                    } else {
                        summary['其他'] += item.amount;
                    }
                    summary.total += item.amount;
                });
                return summary;
            }
        };

        // Modal 控制
        let currentEditingId = null;

        function openExpenseModal(id, activityName) {
            currentEditingId = id;
            const expense = ExpenseManager.getExpense(id);
            
            document.getElementById('modal-title').textContent = activityName;
            document.getElementById('expense-amount').value = expense ? expense.amount : '';
            
            // 重置分類按鈕
            document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('selected'));
            const category = expense ? expense.category : '其他'; // 預設其他
            document.querySelector(`.cat-btn[data-cat="${category}"]`).classList.add('selected');

            document.getElementById('expense-modal').classList.add('active');
        }

        function closeExpenseModal() {
            document.getElementById('expense-modal').classList.remove('active');
            currentEditingId = null;
        }

        function saveCurrentExpense() {
            if (!currentEditingId) return;
            const amount = document.getElementById('expense-amount').value;
            const categoryBtn = document.querySelector('.cat-btn.selected');
            const category = categoryBtn ? categoryBtn.dataset.cat : '其他';
            
            ExpenseManager.saveExpense(currentEditingId, amount, category);
            closeExpenseModal();
        }

        function selectCategory(btn) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        function showSummary() {
            const summary = ExpenseManager.getSummary();
            const html = `
                <div class="space-y-3">
                    <div class="flex justify-between border-b pb-2"><span>交通</span><span class="font-mono-num font-bold">¥${summary['交通'].toLocaleString()}</span></div>
                    <div class="flex justify-between border-b pb-2"><span>餐費</span><span class="font-mono-num font-bold">¥${summary['餐費'].toLocaleString()}</span></div>
                    <div class="flex justify-between border-b pb-2"><span>購物</span><span class="font-mono-num font-bold">¥${summary['購物'].toLocaleString()}</span></div>
                    <div class="flex justify-between border-b pb-2"><span>景點</span><span class="font-mono-num font-bold">¥${summary['景點'].toLocaleString()}</span></div>
                    <div class="flex justify-between border-b pb-2"><span>其他</span><span class="font-mono-num font-bold">¥${summary['其他'].toLocaleString()}</span></div>
                    <div class="flex justify-between pt-2 text-xl font-black text-blue-600"><span>總計</span><span class="font-mono-num">¥${summary.total.toLocaleString()}</span></div>
                </div>
            `;
            document.getElementById('summary-content').innerHTML = html;
            document.getElementById('summary-modal').classList.add('active');
        }

        function closeSummaryModal() {
            document.getElementById('summary-modal').classList.remove('active');
        }

        let currentDay = 'Day4'; // 預設顯示 Day 4 (查看修正效果)
        window.itineraryData = window.getRefinedItineraryData();
        window.switchDay = (day) => {
            currentDay = day;
            window.renderApp(window.itineraryData);
        };
        
        // --- 2. 核心渲染邏輯 ---
        window.renderApp = (itinerary) => {
            const finalItinerary = itinerary || window.getRefinedItineraryData();
            const container = document.getElementById('itinerary-container');
            const dayTabsContainer = document.getElementById('day-tabs');
            const dateDisplay = document.getElementById('current-date-display');

            if (!container || !dayTabsContainer) return;

            // 渲染日期標籤
            dayTabsContainer.innerHTML = DAYS.map(day => `
                <button
                    class="day-tab flex-1 text-center py-2 transition-all ${day === currentDay ? 'border-blue-400 text-blue-400 scale-105 border-b-4' : 'border-transparent text-slate-400 hover:text-white/80 border-b-2'}"
                    onclick="switchDay('${day}')"
                >
                    <div class="text-xs font-light text-slate-300">DAY</div>
                    <div class="text-xl font-bold">${day.replace('Day', '')}</div>
                </button>
            `).join('');

            // 渲染當前日期和天氣
            const currentDate = DATE_MAP[currentDay] || 'N/A';
            dateDisplay.innerHTML = `
                <div class="p-4 bg-white/10 rounded-xl mb-6 flex justify-between items-center backdrop-blur-sm shadow-xl border border-white/20">
                    <div>
                        <div class="text-xs font-bold text-blue-200">今日日期</div>
                        <div class="text-3xl font-extrabold text-white mt-1">${currentDate}</div>
                    </div>
                    <div class="text-right flex flex-col items-end">
                        <div class="text-[10px] font-bold text-blue-600 px-2 py-1 rounded-full inline-block mt-1"></div>
                    </div>
                </div>
            `;

            // 渲染行程列表
            const currentDayData = finalItinerary[currentDay] || [];
            const currentDayKey = currentDay; 
            
            container.innerHTML = currentDayData.map(item => {
                const isTransit = item.type === '交通' || item.transport === '等待'; // V20: 包含等待
                const styleClass = getStyleClass(item.type, item.transport); // V20: 傳入 transport 判斷 style
                const actionIcon = getActionIcon(item.type, item.transport); // V20: 傳入 transport 判斷 icon
                const detailsHtml = item.details.trim().replace(/\n/g, '<br>');
                
                // V19/V20: 取得精確的顯示標籤
                const displayTag = getDisplayTag(item);

                // --- 記帳檢查 ---
                const expense = ExpenseManager.getExpense(item.id);
                const expenseHtml = expense ? `<div class="expense-badge">¥${expense.amount.toLocaleString()}</div>` : '';

                // --- V20/V21: 等待緩衝卡片特殊渲染 ---
                if (item.transport === '等待') {
                    return `
                    <div class="timeline-item flex relative z-10">
                        <div class="time-col flex-shrink-0 pt-4">
                            <div class="text-lg font-bold font-mono-num text-yellow-500">${item.time}</div>
                            ${item.duration && item.duration !== 'N/A' ? `<div class="text-[10px] text-yellow-600 font-bold mt-1">${item.duration}</div>` : ''}
                        </div>
                        
                        <div class="card-wrapper">
                            <div class="timeline-dot ${styleClass}"></div>

                            <div class="timeline-card ${styleClass} p-4 pl-8 pt-3 mb-8" onclick="openExpenseModal('${item.id}', '${item.activity}')">
                                ${expenseHtml}
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-xl">${actionIcon}</span>
                                    <div class="text-lg font-extrabold text-yellow-800">${item.activity}</div>
                                    <div class="text-xs font-bold px-2 py-1 rounded-full tag-bg">${displayTag}</div>
                                </div>
                                
                                <div class="text-sm font-medium pt-1">
                                    <span class="font-bold text-yellow-900">${item.dep_time} - ${item.arr_time}</span>
                                    <span class="text-sm font-medium text-yellow-700 ml-2">(${item.duration})</span>
                                </div>
                                
                                ${item.note ? `
                                    <div class="mt-2 text-xs font-bold flex items-center text-yellow-700 border-t border-yellow-300 pt-2">
                                        <span class="mr-1">💬</span> ${item.note}
                                    </div>` : ''}
                            </div>
                        </div>
                    </div>
                    `;
                }

                // --- 交通卡片特殊渲染 (包含純步行和轉乘) ---
                if (item.type === '交通' || item.transport === '步行') {
                    const icon = getTransportIcon(item.transport);
                    const dep_time = item.dep_time || '?';
                    const arr_time = item.arr_time || '?';
                    const dep_loc = item.dep_loc || '起點';
                    const arr_loc = item.arr_loc || '終點';
                    
                    return `
                    <div class="timeline-item flex relative z-10">
                        <div class="time-col flex-shrink-0 pt-4">
                            <div class="text-lg font-bold font-mono-num text-blue-400">${item.time}</div>
                            ${item.duration && item.duration !== 'N/A' ? `<div class="text-[10px] text-slate-500 font-bold mt-1">${item.duration}</div>` : ''}
                        </div>
                        
                        <div class="card-wrapper">
                            <div class="timeline-dot ${styleClass}"></div>

                            <div class="timeline-card type-transit p-4 pl-8 pt-3 mb-8" onclick="openExpenseModal('${item.id}', '${item.activity}')">
                                ${expenseHtml}
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="text-2xl">${icon}</span>
                                    <div class="text-lg font-extrabold text-primary">${item.transport}</div>
                                    <div class="text-xs font-bold px-2 py-1 rounded-full tag-bg">${item.activity}</div>
                                </div>

                                <div class="flex justify-between items-start text-sm font-medium pt-2 border-t border-slate-200">
                                    
                                    <div class="flex flex-col items-center gap-0.5 text-slate-500 text-center w-1/4">
                                        <span class="text-xs font-bold text-slate-600">發車/起點</span>
                                        <span class="font-mono-num text-slate-800 font-bold text-base">${dep_time}</span>
                                        <span class="text-xs font-medium text-slate-700 mt-0.5">${dep_loc}</span>
                                    </div>
                                    
                                    <div class="text-sm font-bold text-slate-500 mx-3 text-center flex flex-col items-center flex-1 w-2/4">
                                        <div class="text-lg text-blue-600 font-extrabold">${item.duration || 'N/A'}</div>
                                        <div class="text-xs font-light mt-0.5 text-slate-500">${item.transport}</div>
                                    </div>

                                    <div class="flex flex-col items-center gap-0.5 text-slate-500 text-center w-1/4">
                                        <span class="text-xs font-bold text-slate-600">抵達/終點</span>
                                        <span class="font-mono-num text-slate-800 font-bold text-base">${arr_time}</span>
                                        <span class="text-xs font-medium text-slate-700 mt-0.5">${arr_loc}</span>
                                    </div>
                                </div>
                                ${item.note ? `
                                    <div class="mt-3 text-xs font-bold flex items-center text-muted border-t border-slate-200 pt-2">
                                        <span class="mr-1">📝</span> ${item.note}
                                    </div>` : ''}
                            </div>
                        </div>
                    </div>
                    `;
                }

                // --- 停留點卡片 (景點/住宿/吃飯/逛街/彈性) 渲染 ---
                return `
                <div class="timeline-item flex relative z-10">
                    <div class="time-col flex-shrink-0 pt-4">
                        <div class="text-lg font-bold font-mono-num text-white">${item.time}</div>
                        ${item.duration && item.duration !== 'N/A' ? `<div class="text-[10px] text-blue-300 font-bold mt-1">${item.duration}</div>` : ''}
                    </div>
                    
                    <div class="card-wrapper">
                        <div class="timeline-dot ${styleClass}"></div>

                        <div class="timeline-card ${styleClass} p-4 pl-8 pt-3 mb-8" onclick="openExpenseModal('${item.id}', '${item.activity}')">
                            ${expenseHtml}
                            <div class="text-lg font-extrabold text-primary mb-2 flex justify-between items-start">
                                <span class="flex-1">${actionIcon} ${item.activity}</span>
                            </div>
                            <div class="flex items-center gap-3 mb-3">
                                <div class="text-xs font-bold px-2 py-1 rounded tag-bg">
                                    ${item.transport}
                                </div>
                                <div class="text-xs font-bold px-2 py-1 rounded border border-current opacity-70">${displayTag}</div>
                            </div>
                            
                            <div class="detail-text font-medium text-white/90 mt-3">
                                ${detailsHtml} 
                            </div>
                            
                            ${item.note ? `
                                <div class="mt-3 text-sm font-bold flex items-center text-blue-300 border-t border-white/20 pt-2">
                                    <span class="mr-2 text-lg">💡</span> 建議備註：${item.note}
                                </div>` : ''}

                            <a href="${getMapLink(item.activity, currentDayKey)}" target="_blank" onclick="event.stopPropagation()"
                               class="mt-3 block w-full text-center text-sm font-bold bg-white/10 text-blue-200 py-2 rounded-lg hover:bg-white/20 transition-colors">
                                🗺️ 導航至此景點
                            </a>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        };

        // --- 3. 動畫與視窗功能 ---
        function createSnowflakes() {
            const container = document.getElementById('snow-container');
            if (!container) return;
            for (let i = 0; i < 40; i++) {
                const el = document.createElement('div');
                el.classList.add('snowflake');
                el.textContent = Math.random() > 0.5 ? '❄' : '•';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animationDuration = (Math.random() * 5 + 5) + 's';
                el.style.opacity = Math.random() * 0.7;
                el.style.fontSize = (Math.random() * 10 + 10) + 'px';
                el.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(el);
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            createSnowflakes();
            window.switchDay('Day1'); // 預設顯示 Day 1
        });
    </script>
</head>
<body class="min-h-screen relative pb-20">
    <div class="snow-container" id="snow-container"></div>
    
    <div class="max-w-2xl mx-auto min-h-screen relative z-10 shadow-2xl bg-slate-900/30 backdrop-blur-md border-x border-white/10">
        
        <header class="sticky top-0 z-40 text-white shadow-lg" style="background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div class="p-5 flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-black italic tracking-tighter text-white drop-shadow-lg">2026 京阪<span class="text-blue-400">GOGO</span></h1>
                    <div class="text-[10px] tracking-[0.3em] text-blue-200 mt-1 font-bold">WINTER FLAGSHIP EDITION ❄️</div>
                </div>
                <button onclick="showSummary()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-full text-sm shadow-lg transform transition active:scale-95">
                    💰 總花費
                </button>
            </div>
            
            <nav id="day-tabs" class="flex justify-around bg-slate-900/50 pt-1 border-t border-white/10"></nav>
        </header>

        <main class="p-5">
            <div id="current-date-display">
                </div>

            <div class="relative">
                <div class="timeline-spine"></div>
                <div id="itinerary-container"></div>
            </div>
        </main>
        
    </div>

    <div id="expense-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-slate-800">活動名稱</h3>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">花費金額 (JPY)</label>
                <input type="number" id="expense-amount" placeholder="輸入金額 (0 為刪除)" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline font-mono-num text-lg">
            </div>
            <div class="mb-6">
                <label class="block text-gray-700 text-sm font-bold mb-2">分類</label>
                <div class="category-grid">
                    <button class="cat-btn" data-cat="交通" onclick="selectCategory(this)">🚌 交通</button>
                    <button class="cat-btn" data-cat="餐費" onclick="selectCategory(this)">🍜 餐費</button>
                    <button class="cat-btn" data-cat="購物" onclick="selectCategory(this)">🛍️ 購物</button>
                    <button class="cat-btn" data-cat="景點" onclick="selectCategory(this)">⛩️ 景點</button>
                    <button class="cat-btn" data-cat="其他" onclick="selectCategory(this)">📝 其他</button>
                </div>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeExpenseModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">取消</button>
                <button onclick="saveCurrentExpense()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">儲存</button>
            </div>
        </div>
    </div>

    <div id="summary-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-black mb-4 text-slate-800 border-b pb-2">📊 旅費統計</h3>
            <div id="summary-content" class="mb-6 text-lg text-slate-700">
                </div>
            <div class="flex justify-end">
                <button onclick="closeSummaryModal()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full shadow-lg">關閉</button>
            </div>
        </div>
    </div>
</body>
</html>
